<!DOCTYPE html>
<html lang="en">

  <head>

    <!-- Meta Tag -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- SEO -->
    <meta name="description" content="150 words">
    <meta name="author" content="Athul Antony">
    <meta name="url" content="www.techeos.com">
    <meta name="copyright" content="TechEOS">
    <meta name="robots" content="index,follow">


    <title>Grouped/Stacked notifications across all android versions.| TechEOS</title>

    <!-- Favicon -->
    <link rel="shortcut icon" href="../images/favicon/favicon.ico">
    <link rel="apple-touch-icon" sizes="144x144" type="image/x-icon" href="images/favicon/apple-touch-icon.png">

    <!-- All CSS Plugins -->
    <link rel="stylesheet" type="text/css" href="../css/plugin.css">

    <!-- Main CSS Stylesheet -->
    <link rel="stylesheet" type="text/css" href="../css/style.css">

    <!-- Google Web Fonts  -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins:400,300,500,600,700">

    <!-- Syntax Highlighter  -->
    <link rel="stylesheet" type="text/css" href="../css/syntax/shCore.css">
    <link rel="stylesheet" type="text/css" href="../css/syntax/shThemeDefault.css">


    <!-- HTML5 shiv and Respond.js support IE8 or Older for HTML5 elements and media queries -->
    <!--[if lt IE 9]>
	   <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
	   <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->




  </head>

 <body>

   <!--Google Analytics tracking code-->
   <script>
 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
 (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
 m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
 })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

 ga('create', 'UA-104487467-1', 'auto');
 ga('send', 'pageview');

 </script>

	 <!-- Preloader Start -->
     <div class="preloader">
	   <div class="rounder"></div>
      </div>
      <!-- Preloader End -->




    <div id="main">
        <div class="container">
            <div class="row">



                 <!-- About Me (Left Sidebar) Start -->
                  <div class="col-md-3">
                   <div class="about-fixed">

                     <div class="my-pic">
                        <img src="../images/pic/my-pic.png" alt="">
                        <a href="javascript:void(0)" class="collapsed" data-target="#menu" data-toggle="collapse"><i class="icon-menu menu"></i></a>
                         <div id="menu" class="collapse">
                           <ul class="menu-link">
                              <!-- <li><a href="about.html">About</a></li>
                               <li><a href="work.html">Work</a></li>
                               <li><a href="contact.html">Contact</a></li> -->
                                <li>About</li>
                               <li>Work</a></li>
                               <li>Contact</li>
                            </ul>
                         </div>
                        </div>



                      <div class="my-detail">

                        <div class="white-spacing">
                            <h1>Blog by Athul Antony</h1>
                            <span>Android Developer @ <a href="http://entri.me">Entri.Inc</a></span>

                        </div>

                       <ul class="social-icon">
                         <li><a href="https://www.facebook.com/athulantony" target="_blank" class="facebook"><i class="fa fa-facebook"></i></a></li>
                         <li><a href="https://twitter.com/athulantonynp" target="_blank" class="twitter"><i class="fa fa-twitter"></i></a></li>
                         <li><a href="https://www.linkedin.com/in/athul-antony-np-5242b4104/" target="_blank" class="linkedin"><i class="fa fa-linkedin"></i></a></li>
                         <li><a href="https://github.com/athulantonynp" target="_blank" class="github"><i class="fa fa-github"></i></a></li>
                        </ul>

                    </div>
                  </div>
                </div>
                <!-- About Me (Left Sidebar) End -->





                 <!-- Blog Post (Right Sidebar) Start -->
                 <div class="col-md-9">
                    <div class="col-md-12 page-body">
                    	<div class="row">


                            <div class="sub-title">
                           		<a href="../index.html" title="Go to Home Page"><h2>Back Home</h2></a>
                                <a href="#comment" class="smoth-scroll"><i class="icon-bubbles"></i></a>
                             </div>


                            <div class="col-md-12 content-page">
                              <div class="col-md-12 blog-post">


                                <!-- Post Headline Start -->
                                <div class="post-title">
                                    <h1>Grouped/Stacked notifications across all Android versions.</h1>
                                   </div>
                                   <!-- Post Headline End -->


                                <!-- Post Detail Start -->
                                <div class="post-info">
                                    <span>October 15, 2017 / by <a href="#" target="_blank">Athul Antony</a></span>
                                   </div>
                                   <!-- Post Detail End -->


                                    <p>Notifications are the essential part of an android app. A notification is a message you display to the user outside of your app's normal UI. When you tell the system to issue a notification, it first appears as an icon in the notification area. To see the details of the notification, the user opens the notification drawer.  In Google I/O 2017, UX team of Android stated that multiple notifications from the same app will make a big mess among various types of users. You can watch the full video <a href="https://www.youtube.com/watch?v=vwZi56I0Mi0" target="_blank">here</a>.  </p>


                                  <p>In Android N, the team came up with a solution called Bundled/Stacked notification. When creating notifications for a handheld device, you should always aggregate similar notifications into a single summary notification.  And in Android Oreo, they came up with new changes in notifications including notification channels. For devices of version greater than Nougat, Stacked notifications will work fine and you can easily group the notifications and define the click event also.  </p>

                              <!-- Post Image Start -->
                              <div class="post-image margin-top-40 margin-bottom-40">
                                 <img src="/images/blog/nougat_notifications.jpg" alt="">
                                 <p>Stacked notifications in devices of Nougat and later.Image source from <a href="#" target="_blank">www.androidcentral.com</a></p>
                                </div>
                                <!-- Post Image End -->
                                  <p>But in practical ways, If your projects’ minimum target is less than Android N, Things will be hard to implement grouped notifications. There is no one method solution to solve this problem. In our app<a href="https://play.google.com/store/apps/details?id=me.entri.entrime&hl=en" target="_blank">Entri</a>, we tried to implement stacked notifications for the forum and discussion feature inside the app. And we came up with a solution of handling stacking notifications separately for devices.   </p>
                                <p>In our <a href="https://play.google.com/store/apps/details?id=me.entri.entrime&hl=en" target="_blank">Entri app</a> there is a forum feature, where users can ask question and will get the answers for the question. Other users can upvote and downvote the same question. We made some GCM(Planned for a FCM upgrade) notification triggers in the backend. While app receives notifications related to forum activity, we used to stack those notifications and will show it to the user in a single bundled notification. </p>
                                <p>To implement bundled notifications in devices of Nougat and later below code is used.</p>

                                <div class="margin-top-40 margin-bottom-40">
                                 <pre class="brush: js">
            /* Bundled notification on devices of Nougat and later */

            //Version check.
            if (android.os.Build.VERSION.SDK_INT >=Build.VERSION_CODES.N) {


            /**
            * createNougatNotification() will create individual notification with a group key
            * which is a constant string value for identifying and grouping notifications
            * together.
            **/

            NotificationCompat.Builder builder;

            builder  =createNougatNotification(getContext(),desc,title,name);

            builder.setContentIntent(intent);

            builder.setAutoCancel(true); //Cancels notification on click.


            /**
            * Code to handle on click of the individual notifications in
            * notification bundle.
            **/

            Intent targetIntent = new Intent(getContext().getApplicationContext(),
                                  ForumDetails.class);

            targetIntent.putExtra("id",id); //Extras for the activity launch

            Intent parent = new Intent(getContext().getApplicationContext(),
                            ForumHome.class);

            parent.putExtra("history","ForumFragment");  //Extras for the activity launch

            TaskStackBuilder stackBuilder = TaskStackBuilder
                                .create(getContext().getApplicationContext());

            stackBuilder.addNextIntent(parent);

            stackBuilder.addNextIntent(targetIntent);

            PendingIntent intent = stackBuilder.getPendingIntent(0,
                                   PendingIntent.FLAG_UPDATE_CURRENT);

            /**
            * Creates the notification and adds properties.
            * In Oreo onwards, you should set NotificationChannels.
            * For simplicity i am avoiding those codes.
            * for more
            * https://developer.android.com/reference/android/app/NotificationChannel.html
            **/

            Notification notification=builder.build();

            notification.sound = Uri.parse("android.resource://" +
                                  context.getPackageName() + "/" + R.raw.notif);

            notification.defaults = Notification.DEFAULT_LIGHTS;

            //getNotificationId(Context) will return a varying int id to grouping purpose

            getNotificationManager(context).notify(getNotificationId(context)
                                  ,notification);
            /**
            * As I mentioned, we have to create summary notification.
            * SetGroupSummary(true) for identifying it as a summary notifications
            **/

            NotificationCompat.Builder summary=createSummaryForNougat(context);

            TaskStackBuilder summaryStackBuilder = TaskStackBuilder.create
                                            (context.getApplicationContext());
            Intent summaryParent = new Intent(context.getApplicationContext(),
                                   ForumHome.class);

            summaryParent.putExtra("history","ForumFragment");

            summaryStackBuilder.addNextIntent(summaryParent);

            summaryStackBuilder.addNextIntent(parent);

            PendingIntent summaryIntent = summaryStackBuilder.getPendingIntent(0,
                                          PendingIntent.FLAG_UPDATE_CURRENT);

            summary.setContentIntent(summaryIntent);

            summary.setAutoCancel(true);

            getNotificationManager(context).notify
                          (getSummaryNotificationId(context),summary.build());
            }

            /**
            * Helper methods
            **/

            /**
            * Creates individual notification to the devices of nougat and later.
            * @return notificaionCompat.Builder class object to build notification.
            */

            public NotificationCompat.Builder createNougatNotification

            (Context context,String description,String title,String url){

            NotificationCompat.Builder builder=new NotificationCompat.Builder(context);

            builder.setContentText(description);

            builder.setContentTitle(title);

            builder.setLargeIcon(getBitmapFromURL(url));


            builder.setColor(ContextCompat.getColor(context, R.color.brand_blue));

            builder.setSmallIcon(R.drawable.ic_notification_small);

            builder.setAutoCancel(true);

            builder.setGroup(GROUP_KEY_NOTIFICATION);

            return  builder;
            }

            /**
            * Creates summary notification to the devices of nougat and later.
            * @param context Context of the Service class.
            * @return notificaionCompat.Builder class object to build notification.
            */

           public NotificationCompat.Builder createSummaryForNougat(Context context){

               NotificationCompat.Builder builder=new NotificationCompat.Builder(context);

               builder.setContentTitle("Click to view the notifications");

               builder.setSmallIcon(R.drawable.ic_notification_small);

               builder.setGroup(GROUP_KEY_NOTIFICATION);

               builder.setAutoCancel(true);

               builder.setGroupSummary(true); //Don't forget this method call.

               return  builder;
           }



                                </pre>
                               </div>
                              <p>To create a stack, call <a href="https://developer.android.com/reference/android/support/v4/app/NotificationCompat.Builder.html#setGroup(java.lang.String)" target="_blank" >setGroup()</a> for each notification you want in the stack and specify a group key. Then call <a href="https://developer.android.com/reference/java/lang/Object.html#notify()" target="_blan">notify()</a> to send it to the device. If we use same group key, we can stack the notification with the old available notification. We have to create a summary notification with the same notification group key and make it as the summary notification by calling <a href="https://developer.android.com/reference/android/support/v4/app/NotificationCompat.Builder.html#setGroupSummary(boolean)" target="_blank">setGroupSummary(true).</a> </p>
                              <p> As an addition we can define the targetIntent class to each individual notification and to the summary notification also. So if the user clicks on the total single bundled notification, the target intent of summary notification will be launched. In our case, if the user clicks on the summary, (ie, total single notification) App will launch to the forum activity home screen. But if the user expands the notification and clicks on the single notification, it will launch the related forum thread’s activity. Simple and easy logic.
                              </p>

                              <p>But in the version earlier Nougat, we cannot simply set up a stacked notification by calling setGroup() method. It won’t make any change in the previous versions. From many stack overflow threads, we concluded that by setting <a href="https://developer.android.com/reference/android/app/Notification.InboxStyle.html" target="_blank"> InboxMessage()</a>  style, we can achieve the grouped notifications. But there lies another issue. You can add notifications as a line to the single summary notification. But if we uses GCM or FCM and the notifications are not sent at a single time but an unknown time period recurringly, those method won’t work. Notifications may not group together but all notifications are displayed as separate notifications.(ie, You cannot add a new notification to already existing notification)  In order to solve this issue, we can rely on many strategies. </p>

                                <blockquote class="margin-top-40 margin-bottom-40">
                                  <p>   1.Developers can tell the backend team to send notifications as string array in order to keep them bundled.
                                  </br>2.Handle it in the front-end.</p>
                                   </blockquote>



<p>For the first solution, it might not work well all the time. Simply, it won’t work out all the time. But the second solution can be done easily using our Shared Preference  class and Gson library. Below code structure will explain the tricks to you. FYI, this is the exact behaviour we have seen in famous apps like Gmail, Whatsapp and Hike etc,.</p>

    <div class="margin-top-40 margin-bottom-40">
<pre class="brush: js">
    /*  Bundled notification on devices of Marshmallow and earlier */

    //Version check
    if (android.os.Build.VERSION.SDK_INT <=Build.VERSION_CODES.M) {

      /**
      * Only summary notification is implemented.
      * You can add all individual notification descriptions
      * as a line in the summary notification.
      * Since notification over riding won't work in this method,
      * we are saving notification description strings in an arraylist
      * and saving the arraylist object in sharedpref as a single string
      * by the help of Gson class.
      * when user clicks on appropirate notification, that sharedpref
      * key-value is cleared. Thus we can obtain the same behaviour
      * of stacked notification.
      **/

      /**
      * processStringDatas() method will return all the
      * saved strings in the SharedPreference which will
      * added as a line in the grouped notification.
      **/

      ArrayList<String> notificationDescObject=
                          processStringDatas(context,title,desc);


      NotificationCompat.Builder summary=getSummaryBuilder(context);

      summary.setContentTitle(title);

      summary.setContentText(desc);

      summary.setColor(ContextCompat.getColor
                      (context, R.color.brand_blue));

      summary.setLargeIcon(getBitmapFromURL(image_url));

      summary.setGroupSummary(true); //Don't forget to add this line.

      Intent targetIntent = new Intent
                (context.getApplicationContext(), DoubtsDetail.class);

      targetIntent.putExtra("id",id);

      Intent summaryParent = new Intent(context.getApplicationContext(),
                             ForumHome.class);

      summaryParent.putExtra("history","ForumFragment");

      TaskStackBuilder summaryStackBuilder = TaskStackBuilder
                                  .create(context.getApplicationContext());

      /**
      * Setting inboxStyle to notification to add each individual notification's
      * description.
      **/

      NotificationCompat.InboxStyle inboxStyle = new NotificationCompat.InboxStyle();

      summary.setStyle(inboxStyle);

      inboxStyle.setBigContentTitle(title);

      /**
      * Magic happens here!
      * All the strings of our notificationDescObject is added
      * and grouping done.
      **/

      for(String string:notificationDescObject){

          inboxStyle.addLine(string);

      }

      //Can set no.of messages as a summary.

      inboxStyle.setSummaryText(String.valueOf
                    (notificationObject.size())+" Messages");

      summaryParent.putExtra("history","ForumFragment");

      summaryStackBuilder.addNextIntent(summaryParent);

      summaryStackBuilder.addNextIntent(targetIntent);

      PendingIntent summaryIntent = summaryStackBuilder
                    .getPendingIntent(0, PendingIntent.FLAG_UPDATE_CURRENT);

      summary.setContentIntent(summaryIntent);

      summary.setAutoCancel(true);

      getNotificationManager(context).notify(getConstantId(context),notification);

      }

      /**
      * Helper method to save the strings in shared preference.
      **/

      /**
      * This method will save all the notifications on shared pereference
      * and will return the String array list which will be processed.
      * @param context context of current service
      * @param title   title of notification. Not used in this demo mode.
      * @param desc    String to save in SP.
      * @return        String value of ArrayList.class object.
      */

      private ArrayList<String> processStringDatas
        (Context context, String title, String desc) {

       SharedPreferences sp=getSharedPreferece(context);

       ArrayList<String> notificationObject;

       String notif_content=sp.getString("notif_content",null);

       if(notif_content!=null){

           notificationObject=new Gson()
           .fromJson(notif_content,ArrayList.class);

       }else {

           notificationObject=new ArrayList<>();
       }

       notificationObject.add(desc);

       SharedPreferences.Editor editor =sp.edit();

       editor.putString("notif_content", new Gson().toJson(notificationObject));

       editor.apply();

       return notificationObject;
   }

</pre>
</div>

<p>Below pictures are the one to show how stacked notifications are rendered in devices of  pre Lollipop and  post Lollipop. Always remember to clear the shared preference key value pair when user clicks on the notifications. Now stacked notification behaviour can be achieved across all the devices in Android by the method i have described.
</P>
<!-- Post Image Start -->
<div class="post-image margin-top-40 margin-bottom-40">
   <img src="/images/blog/lollipop_notifications.png" alt="">
   <p>Stacked notifications in devices of Marshmallow and earlier.</a></p>
  </div>
  <!-- Post Image End -->




                                  <!-- Post Author Bio Box Start -->
                                  <div class="about-author margin-top-70 margin-bottom-50">

                                    <div class="picture">
                                      <img src="../images/blog/author_new.jpg" class="img-responsive" alt="">
                                     </div>

                                    <div class="c-padding">
                                       <h3>Article By <a href="../index.html" target="_blank" data-toggle="tooltip" data-placement="top" title="Visit Athul's Website">Athul Antony</a></h3>
                                       <p>Liked my post or having doubts ? Mail me at <a href="mailto:someone@example.com?Subject=TechEOS|1615" target="_top"> athul@entri.me </a></p>
                                      </div>
                                    </div>
                                    <!-- Post Author Bio Box End -->






                       <!-- Footer Start -->
                       <div class="col-md-12 page-body margin-top-50 footer">
                          <footer>
                          <ul class="menu-link">
                               <li><a href="../index.html">Home</a></li>
                               <li><a href="index.html">About</a></li>
                               <li><a href="../index.html">Work</a></li>
                               <li><a href="../index.html">Contact</a></li>
                            </ul>

                          <p>© Copyright 2017 TechEOS. All rights reserved</p>


						  <!-- UiPasta Credit Start -->
                          <div class="uipasta-credit">Design By <a href="http://www.uipasta.com" target="_blank">UiPasta</a></div>
                          <!-- UiPasta Credit End -->


                         </footer>
                       </div>
                       <!-- Footer End -->


                  </div>
                  <!-- Blog Post (Right Sidebar) End -->

            </div>
         </div>
      </div>


    <!-- Back to Top Start
    <a href="#" class="scroll-to-top"><i class="fa fa-long-arrow-up"></i></a>
     Back to Top End -->


    <!-- All Javascript Plugins  -->
    <script type="text/javascript" src="../js/jquery.min.js"></script>
    <script type="text/javascript" src="../js/plugin.js"></script>

    <!-- Main Javascript File  -->
    <script type="text/javascript" src="../js/scripts.js"></script>

    <!-- Syntax Highlighter Javascript File  -->
    <script type="text/javascript" src="../js/syntax/shCore.js"></script>
    <script type="text/javascript" src="../js/syntax/shBrushCss.js"></script>
    <script type="text/javascript" src="../js/syntax/shBrushJScript.js"></script>
    <script type="text/javascript" src="../js/syntax/shBrushPerl.js"></script>
    <script type="text/javascript" src="../js/syntax/shBrushPerl.js"></script>
    <script type="text/javascript" src="../js/syntax/shBrushPhp.js"></script>
    <script type="text/javascript" src="../js/syntax/shBrushPlain.js"></script>
    <script type="text/javascript" src="../js/syntax/shBrushPython.js"></script>
    <script type="text/javascript" src="../js/syntax/shBrushRuby.js"></script>
    <script type="text/javascript" src="../js/syntax/shBrushSql.js"></script>
    <script type="text/javascript" src="../js/syntax/shBrushVb.js"></script>
    <script type="text/javascript" src="../js/syntax/shBrushXml.js"></script>

	<!-- Syntax Highlighter Call Function -->
	<script type="text/javascript">
		SyntaxHighlighter.config.clipboardSwf = '../js/syntax/clipboard.swf';
		SyntaxHighlighter.all();
	</script>


   </body>
 </html>
   
